var SPP=SPP||{REVISION:"Beta",AUTHOR:"flashhawk",BLOG:"flashquake.cn",github:"https://github.com/flashhawk",weibo:"http://weibo.com/flashawk"};SPP.frameTime=0;SPP.inherit=function(a,b){a.superClass=b;a.prototype=Object.create(b.prototype);a.prototype.constructor=a};SPP.extend=function(a,b){if(!b||"object"!==typeof b)return a;for(var c=Object.keys(b),d=c.length;d--;)a[c[d]]=b[c[d]];return a};
(function(){for(var a=0,b=["ms","moz","webkit","o"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];void 0===window.requestAnimationFrame&&(window.requestAnimationFrame=function(b,c){var f=Date.now(),h=Math.max(0,16-(f-a)),g=window.setTimeout(function(){b(f+h)},h);a=f+h;return g});window.cancelAnimationFrame=window.cancelAnimationFrame||
function(a){window.clearTimeout(a)}})();SPP.Event=function(a){this.type=a;this.target=null};SPP.Event.prototype={constructor:SPP.Event,clone:function(){return new SPP.Event(this.type,this.target)}};SPP.EventDispatcher=function(){};
SPP.EventDispatcher.prototype={constructor:SPP.EventDispatcher,addEventListener:function(a,b){void 0===this._listeners&&(this._listeners={});var c=this._listeners;void 0===c[a]&&(c[a]=[]);-1===c[a].indexOf(b)&&c[a].push(b)},dispatchEvent:function(a){if(void 0!==this._listeners){var b=this._listeners[a.type];if(void 0!=b){a.target=this;for(var b=b.slice(),c=0,d=b.length;c<d;c++)b[c].call(this,a)}}},removeEventListener:function(a,b){if(void 0!==this._listeners){var c=this._listeners,d=c[a].indexOf(b);
-1!==d&&c[a].splice(d,1)}},removeAllEventListeners:function(){if(void 0!==this._listeners){var a=this._listeners,b;for(b in a)delete a[b]}}};SPP.EventDispatcher.prototype.on=SPP.EventDispatcher.prototype.addEventListener;SPP.EventDispatcher.prototype.once=function(a,b){function c(d){this.removeEventListener(a,c);b.call(this,d)}this.addEventListener(a,c)};SPP.Rectangle=function(a,b,c,d){this.x=a||0;this.y=b||0;this.width=c||0;this.height=d||0};
SPP.Rectangle.prototype={constructor:SPP.Rectangle,top:function(){return this.y},bottom:function(){return this.y+this.height},left:function(){return this.x},right:function(){return this.x+this.width},topLeft:function(){return new SPP.Point(this.x,this.y)},bottomRight:function(){return new SPP.Point(this.right(),this.bottom())},clone:function(){return SPP.Rectangle(this.x,this.y,this.width,this.height)},toString:function(){return"[Rectangle (x\x3d"+this.x+" y\x3d"+this.y+" width\x3d"+this.width+" height\x3d"+
this.height+")]"}};SPP.Vector2D=function(a,b){this.x=a||0;this.y=b||0};
SPP.Vector2D.prototype={constructor:SPP.Vector2D,toString:function(){return"[Vector2D (x\x3d"+this.x+" y\x3d"+this.y+")]"},clone:function(){return new SPP.Vector2D(this.x,this.y)},copy:function(a){this.x=a.x;this.y=a.y;return this},reset:function(a,b){this.x=a||0;this.y=b||0;return this},equals:function(a){return this.x==a.x&&this.y==a.y},add:function(a){this.x+=a.x;this.y+=a.y;return this},addNew:function(a){return new SPP.Vector2D(this.x+a.x,this.y+a.y)},addVectors:function(a,b){this.x=a.x+b.x;
this.y=a.y+b.y;return this},sub:function(a){this.x-=a.x;this.y-=a.x;return this},subNew:function(a){return new SPP.Vector2D(this.x-a.x,this.y-a.y)},subVectors:function(a,b){this.x=a.x-b.x;this.y=a.y-b.y;return this},negate:function(){this.x*=-1;this.y*=-1;return this},negateX:function(){this.x*=-1;return this},negateY:function(){this.y*=-1;return this},negateNew:function(){return new SPP.Vector2D(-this.x,-this.y)},scale:function(a){this.x*=a;this.y*=a;return this},scaleX:function(a){this.x*=a;return this},
scaleY:function(a){this.y*=a;return this},scaleNew:function(a){return new SPP.Vector2D(this.x*a,this.y*a)},getLength:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},setLength:function(a){a/=this.getLength();this.scale(a);return this},getAngle:function(){return SPP.MathUtils.atan2D(this.y,this.x)},setAngle:function(a){var b=this.getLength();this.x=b*SPP.MathUtils.cosD(a);this.y=b*SPP.MathUtils.sinD(a);return this},rotate:function(a){var b=SPP.MathUtils.sinD(a);a=SPP.MathUtils.cosD(a);var c=
this.x,d=this.y;this.x=c*a-d*b;this.y=c*b+d*a;return this},rotateNew:function(a){var b=this.clone();b.rotate(a);return b},dot:function(a){return this.x*a.x+this.y*a.y},projection:function(a){var b=this.angleBetween(a),b=this.getLength()*SPP.MathUtils.cosD(b)/a.getLength();return a.scaleNew(b)},normalizeNew:function(){return this.clone().normalize()},normalize:function(){0!=this.getLength()?this.scale(1/this.getLength()):this.scale(0);return this},getNormal:function(){return new SPP.Vector2D(-this.y,
this.x)},isPerpTo:function(a){return 0==this.dot(a)},angleBetween:function(a){a=this.dot(a)/(this.getLength()*a.getLength());return SPP.MathUtils.acosD(a)},distanceTo:function(a){return Math.sqrt(Math.pow(this.x-a.x,2)+Math.pow(this.y-a.y,2))}};SPP.Group=function(a){var b=a,c={};this.createParticle=function(a){a=b.createParticle(a);a.parent=this;return a};this.getForceMap=function(){return c};this.addForce=function(a,b){c[a]=b};this.removeForce=function(a){delete c[a]};this.removeAllForces=function(){for(var a in c)delete c[a]};this.dealloc=function(){this.removeAllForces();c=b=null}};SPP.Particle=function(){this.parent=null;this.position=new SPP.Vector2D(0,0);this.velocity=new SPP.Vector2D(0,0);this.damp=new SPP.Vector2D(0.1,0.1);this.life=Infinity;this._forcesMap={};this.extra={};this.resultant=new SPP.Vector2D;this.boundary=null;this.boundaryType=SPP.Particle.OFFSCREEN;this.bounceIntensity=2;this.onUpdate=null};SPP.Particle.OFFSCREEN="offscreen";SPP.Particle.BOUNCE="bounce";
SPP.Particle.prototype={constructor:SPP.Particle,init:function(a,b,c){0>=c?this.dispatchEvent(new SPP.Event("dead")):(this.life=c||Infinity,this.position.reset(a,b))},getForce:function(a){return this._forcesMap[a]},addForce:function(a,b){this._forcesMap[a]=b},removeForce:function(a){delete this._forcesMap[a]},removeAllForces:function(){for(var a in this._forcesMap)delete this._forcesMap[a]},render:function(){this.update();this.onUpdate&&this.onUpdate.apply(this);if(null!=this.parent){var a=this.parent.getForceMap(),
b;for(b in a)a[b].isActive(this)||delete a[b]}for(b in this._forcesMap)this._forcesMap[b].isActive(this)||delete this._forcesMap[b];this.velocity.add(this.resultant);this.resultant.reset(0,0);this.velocity.x*=1-this.damp.x;this.velocity.y*=1-this.damp.y;this.position.add(this.velocity);if(null!=this.boundary)this[this.boundaryType]();this.life-=SPP.frameTime;0<this.life||this.dispatchEvent(new SPP.Event("dead"))},update:function(){},bounce:function(){if(this.position.x<this.boundary.left()||this.position.x>
this.boundary.right())this.position.x=this.position.x<this.boundary.left()?this.boundary.left():this.boundary.right(),this.velocity.scaleX(-this.bounceIntensity);if(this.position.y<this.boundary.top()||this.position.y>this.boundary.bottom())this.position.y=this.position.y<this.boundary.top()?this.boundary.top():this.boundary.bottom(),this.velocity.scaleY(-this.bounceIntensity);this.resultant.scale(0)},offscreen:function(){this.position.x<this.boundary.left()&&(this.position.x=this.boundary.right());
this.position.x>this.boundary.right()&&(this.position.x=this.boundary.left());this.position.y<this.boundary.top()&&(this.position.y=this.boundary.bottom());this.position.y>this.boundary.bottom()&&(this.position.y=this.boundary.top())},dealloc:function(){this.onUpdate=this.bounceIntensity=this.boundaryType=this.boundary=this.resultant=this.extra=this._forcesMap=this.life=this.damp=this.velocity=this.position=this.parent=null},reset:function(){this.position.reset(0,0);this.velocity.reset(0,0);this.damp.reset(0.1,
0.1);this.life=0;this.removeAllForces();this.removeAllEventListeners();for(var a in this.extra)delete this.extra[a];this.resultant.reset(0,0);this.boundary=null;this.boundaryType=SPP.Particle.OFFSCREEN;this.bounceIntensity=2;this.parent=this.onUpdate=null}};SPP.extend(SPP.Particle.prototype,SPP.EventDispatcher.prototype);SPP.Pool=function(){var a=[];this.get=function(b){for(var c in a)if(a[c].constructor===b)return a.splice(c,1)[0];return new b};this.recycle=function(b){a.push(b)};this.getObjects=function(){return a};this.dealloc=function(){for(var b=0,c=a.length;b<c;b++)a[b].dealloc();a.length=0;a=null}};SPP.ParticleSystem=function(){var a=[],b=new SPP.Pool,c=[],d=new SPP.Pool,e=[],f=null,h=!1;this.getParticles=function(){return a};this.createParticle=function(c){c=b.get(c);c.reset();a.push(c);return c};this.createForce=function(a){a=d.get(a);c.push(a);return a};this.createGroup=function(){var a=new SPP.Group(this);e.push(a);return a};this.destroyEmitter=function(c){var d=e.indexOf(c);if(-1!=d){for(var f=a.length;0<f--;)a[f].parent===c&&(b.recycle(a[f]),a.splice(f,1));e.splice(d,1);c.dealloc()}};
this.destroyAllGroup=function(){for(var c=a.length;0<c--;)null!=a[c].parent&&(b.recycle(a[c]),a.splice(c,1));for(var d=0,c=e.length;d<c;d++)e[d].dealloc();e.length=0};this.render=function(){if(h){SPP.frameTime=0.0010*(Date.now()-f);f=Date.now();for(var g=a.length,e=0;e<g;e++)a[e].render();for(;0<g--;)0>=a[g].life&&(b.recycle(a[g]),a.splice(g,1));for(g=c.length;0<g--;)0>=c[g].life&&(d.recycle(c[g]),c.splice(g,1))}};this.start=function(){f=Date.now();h=!0};this.stop=function(){h=!1};this.destroy=function(){this.stop();
h=f=null;for(var d=0,k=a.length;d<k;d++)a[d].dealloc();d=0;for(k=e.length;d<k;d++)e[d].dealloc();d=0;for(k=c.length;d<k;d++)c[d].dealloc();e.length=0;e=null;a.length=0;a=null;b.dealloc();b=null}};SPP.Force=function(){this.value=new SPP.Vector2D;this.life=Infinity};SPP.Force.prototype={constructor:SPP.Force,init:function(a,b,c){this.value.reset(a,b);this.life=c||Infinity},isActive:function(a){if(0>=(this.life-=SPP.frameTime))return this.dispatchEvent(new SPP.Event("dead")),!1;this.update(a);return!0},update:function(a){a.resultant.add(this.value)},dealloc:function(){this.value=null;this.life=void 0}};SPP.extend(SPP.Force.prototype,SPP.EventDispatcher.prototype);SPP.Attraction=function(){SPP.Force.call(this)};SPP.inherit(SPP.Attraction,SPP.Force);SPP.Attraction.prototype.init=function(a,b,c,d){SPP.Force.prototype.init.call(this,0,0,d);this.maxValue=b;this.r=c;this.attractionPosition=a};SPP.Attraction.prototype.update=function(a){this.attractionPosition.distanceTo(a.position)<this.r?this.value.reset(0,0):(this.value.subVectors(this.attractionPosition,a.position),this.value.normalize().setLength(this.maxValue));a.resultant.add(this.value)};
SPP.Attraction.prototype.dealloc=function(){SPP.Force.prototype.dealloc.apply(this);this.r=this.maxValue=void 0;this.attractionPosition=null};SPP.Brownian=function(){SPP.Force.call(this)};SPP.inherit(SPP.Brownian,SPP.Force);SPP.Brownian.prototype.init=function(a,b,c){SPP.Force.prototype.init.call(this,0,0,c);this.maxValue=a;this.cycle=b;this.pastTime=0;this.value.reset((2*Math.random()-1)*this.maxValue,(2*Math.random()-1)*this.maxValue)};
SPP.Brownian.prototype.update=function(a){this.pastTime+=SPP.frameTime;this.pastTime>=this.cycle&&(this.value.reset((2*Math.random()-1)*this.maxValue,(2*Math.random()-1)*this.maxValue),this.pastTime=0);a.resultant.add(this.value)};SPP.Brownian.prototype.dealloc=function(){SPP.Force.prototype.dealloc.apply(this);this.pastTime=this.cycle=this.maxValue=void 0};SPP.SimpleBrownian=function(){SPP.Force.call(this)};SPP.inherit(SPP.SimpleBrownian,SPP.Force);SPP.SimpleBrownian.prototype.init=function(a,b){SPP.Force.prototype.init.call(this,0,0,b);this.maxValue=a};SPP.SimpleBrownian.prototype.update=function(a){this.value.reset((2*Math.random()-1)*this.maxValue,(2*Math.random()-1)*this.maxValue);a.resultant.add(this.value)};SPP.SimpleBrownian.prototype.dealloc=function(){SPP.Force.prototype.dealloc.apply(this);this.cycle=this.maxValue=void 0};SPP.Gravity=function(){SPP.Force.call(this)};SPP.inherit(SPP.Gravity,SPP.Force);SPP.Gravity.prototype.init=function(a){SPP.Force.prototype.init.call(this,0,a,Infinity)};SPP.Repulsion=function(){SPP.Force.call(this)};SPP.inherit(SPP.Repulsion,SPP.Force);SPP.Repulsion.prototype.init=function(a,b,c,d){SPP.Force.prototype.init.call(this,0,0,d);this.maxValue=b;this.r=c;this.repulsionPosition=a};SPP.Repulsion.prototype.update=function(a){this.repulsionPosition.distanceTo(a.position)>this.r?this.value.reset(0,0):(this.value.subVectors(a.position,this.repulsionPosition),this.value.normalize().setLength(this.maxValue));a.resultant.add(this.value)};
SPP.Repulsion.prototype.dealloc=function(){SPP.Force.prototype.dealloc.apply(this);this.r=this.maxValue=void 0;this.repulsionPosition=null};SPP.MathUtils=function(){};SPP.MathUtils.toDegree=function(a){return 180*(a/Math.PI)};SPP.MathUtils.toRadian=function(a){return a/180*Math.PI};SPP.MathUtils.sinD=function(a){return Math.sin(SPP.MathUtils.toRadian(a))};SPP.MathUtils.asinD=function(a){return SPP.MathUtils.toDegree(Math.asin(a))};SPP.MathUtils.cosD=function(a){return Math.cos(SPP.MathUtils.toRadian(a))};SPP.MathUtils.acosD=function(a){return SPP.MathUtils.toDegree(Math.acos(a))};SPP.MathUtils.tanD=function(a){return Math.tan(SPP.MathUtils.toRadian(a))};
SPP.MathUtils.atanD=function(a){return SPP.MathUtils.toDegree(Math.atan(a))};SPP.MathUtils.atan2D=function(a,b){return SPP.MathUtils.toDegree(Math.atan2(a,b))};SPP.MathUtils.random=function(a){return a*Math.random()>>0};SPP.SpriteImage=function(){SPP.Particle.call(this);this.texture=this.context=null;this.scale=1;this.rotation=0;this.alpha=1;this.regY=this.regX=0.5};SPP.inherit(SPP.SpriteImage,SPP.Particle);
SPP.SpriteImage.prototype.update=function(){null==this.context||null==this.texture||(this.context.globalAlpha=this.alpha,this.context.translate(this.position.x,this.position.y),this.context.rotate(this.rotation),this.context.scale(this.scale,this.scale),this.context.drawImage(this.texture,0,0,this.texture.width,this.texture.height,-this.texture.width*this.regX,-this.texture.height*this.regY,this.texture.width,this.texture.height),this.context.setTransform(1,0,0,1,0,0),this.context.globalAlpha=1)};
SPP.SpriteImage.prototype.init=function(a,b,c,d,e){SPP.Particle.prototype.init.apply(this,[a,b,c]);this.context=e;this.texture=d};SPP.SpriteImage.prototype.reset=function(){SPP.Particle.prototype.reset.apply(this);this.texture=this.context=null;this.scale=1;this.rotation=0;this.alpha=1;this.regY=this.regX=0.5};SPP.SpriteImage.prototype.width=function(){return this.texture.width*this.scale};SPP.SpriteImage.prototype.height=function(){return this.texture.height*this.scale};